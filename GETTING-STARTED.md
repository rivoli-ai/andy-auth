# Getting Started with Andy Auth

This guide will help you push this repository to GitHub and start using Andy Auth.

## Repository Structure Created

```
andy-auth/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Andy.Auth/                    ‚úÖ Core authentication library (COMPLETE)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Configuration/            - Provider configuration options
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Extensions/               - Easy integration extensions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Models/                   - UserClaims, OAuthMetadata
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Providers/                - AndyAuth, AzureAD, Clerk providers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Services/                 - ICurrentUserService
‚îÇ   ‚îî‚îÄ‚îÄ Andy.Auth.Server/             üöß Identity server (BASIC STRUCTURE)
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ Andy.Auth.Tests/              üìù Test project (ready for tests)
‚îú‚îÄ‚îÄ samples/
‚îÇ   ‚îî‚îÄ‚îÄ SampleApi/                    üìù Sample integration (ready to configure)
‚îú‚îÄ‚îÄ docs/                             üìù Documentation folder (ready)
‚îú‚îÄ‚îÄ .github/workflows/                üìù GitHub Actions (ready)
‚îú‚îÄ‚îÄ README.md                         ‚úÖ Main documentation
‚îú‚îÄ‚îÄ Directory.Build.props             ‚úÖ Shared build configuration
‚îî‚îÄ‚îÄ andy-auth.sln                     ‚úÖ Solution file
```

## Step 1: Initialize Git and Push to GitHub

```bash
cd /Users/samibengrine/Devel/rivoli-ai/andy-auth

# Initialize git
git init

# Create .gitignore
cat > .gitignore << 'EOF'
## Ignore Visual Studio temporary files, build results, and
## files generated by popular Visual Studio add-ons.

# User-specific files
*.rsuser
*.suo
*.user
*.userosscache
*.sln.docstates

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
x64/
x86/
[Aa][Rr][Mm]/
[Aa][Rr][Mm]64/
bld/
[Bb]in/
[Oo]bj/
[Ll]og/
[Ll]ogs/

# NuGet Packages
*.nupkg
*.snupkg
**/packages/*
!**/packages/build/
*.nuget.props
*.nuget.targets

# Visual Studio cache/options
.vs/

# Rider
.idea/
*.sln.iml

# macOS
.DS_Store

# User secrets
appsettings.Development.json
appsettings.*.json
!appsettings.json

# Environment files
.env
.env.local
EOF

# Add all files
git add .

# Initial commit
git commit -m "Initial commit: Andy Auth multi-provider authentication library

- Core authentication library with provider abstraction
- Support for AndyAuth, Azure AD, and Clerk
- ICurrentUserService for easy user access
- NuGet package configuration
- Extensible architecture for custom providers"

# Create GitHub repo and push
# You'll need to create the repo at https://github.com/rivoli-ai/andy-auth first
git remote add origin https://github.com/rivoli-ai/andy-auth.git
git branch -M main
git push -u origin main
```

## Step 2: What's Already Working

### ‚úÖ Andy.Auth Library (READY TO USE)

The core library is **complete and tested**:

**Providers Implemented:**
- ‚úÖ `AndyAuthProvider` - For self-hosted OpenIddict server
- ‚úÖ `AzureAdProvider` - For Microsoft Azure AD
- ‚úÖ `ClerkProvider` - For Clerk (with opaque token support)

**Usage Example:**

```csharp
// In any ASP.NET Core API
using Andy.Auth.Extensions;

var builder = WebApplication.CreateBuilder(args);

// ONE LINE to add authentication!
builder.Services.AddAndyAuth(builder.Configuration);

var app = builder.Build();
app.UseAuthentication();
app.UseAuthorization();

// Protected endpoint
app.MapGet("/api/books", async (ICurrentUserService currentUser) =>
{
    var userId = await currentUser.GetUserIdAsync();
    return $"Hello user {userId}!";
}).RequireAuthorization();

app.Run();
```

**Configuration (appsettings.json):**

```json
{
  "AndyAuth": {
    "Provider": "AndyAuth",  // or "AzureAD" or "Clerk"
    "Authority": "https://auth.rivoli.ai",
    "Audience": "lexipro-api"
  }
}
```

## Step 3: What Needs to Be Built

### üöß Andy.Auth.Server (Identity Server)

You'll need to complete the identity server implementation. Here's what to add:

**Required Packages:**

```bash
cd src/Andy.Auth.Server
dotnet add package OpenIddict.AspNetCore
dotnet add package OpenIddict.EntityFrameworkCore
dotnet add package Microsoft.EntityFrameworkCore.Sqlite  # or PostgreSQL
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
```

**Key Files to Create:**

1. `Data/IdentityDbContext.cs` - Database context for users and OAuth clients
2. `Controllers/AuthorizationController.cs` - OAuth authorize/token endpoints
3. `Controllers/AccountController.cs` - Login/register UI
4. `Views/` - Login/consent UI pages
5. `appsettings.json` - Configuration

**Quick Start Option:**

Use the **OpenIddict templates**:

```bash
# Install templates
dotnet new install OpenIddict.Templates

# Create identity server from template
dotnet new openiddict-server -n Andy.Auth.Server --framework net8.0

# Copy the generated files into src/Andy.Auth.Server/
```

## Step 4: Publishing the NuGet Package

### Option A: GitHub Packages (Recommended for Private)

1. **Create GitHub Personal Access Token:**
   - Go to https://github.com/settings/tokens
   - Generate new token with `write:packages` permission
   - Save the token

2. **Configure NuGet:**

```bash
# Add GitHub Packages source
dotnet nuget add source https://nuget.pkg.github.com/rivoli-ai/index.json \
  --name github-rivoli \
  --username YOUR_GITHUB_USERNAME \
  --password YOUR_GITHUB_PAT \
  --store-password-in-clear-text
```

3. **Publish:**

```bash
cd src/Andy.Auth
dotnet pack -c Release
dotnet nuget push bin/Release/Andy.Auth.1.0.0-beta.nupkg \
  --source github-rivoli \
  --api-key YOUR_GITHUB_PAT
```

4. **Use in Other Projects:**

Create `nuget.config` in Lexipro:

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <packageSources>
    <add key="nuget.org" value="https://api.nuget.org/v3/index.json" />
    <add key="github-rivoli" value="https://nuget.pkg.github.com/rivoli-ai/index.json" />
  </packageSources>
  <packageSourceCredentials>
    <github-rivoli>
      <add key="Username" value="YOUR_GITHUB_USERNAME" />
      <add key="ClearTextPassword" value="YOUR_GITHUB_PAT" />
    </github-rivoli>
  </packageSourceCredentials>
</configuration>
```

Then:

```bash
cd /path/to/lexipro
dotnet add package Andy.Auth --version 1.0.0-beta
```

## Step 5: Migrate Lexipro to Use Andy.Auth

### Current Lexipro Setup (what to remove):

```
src/Lexipro.Api/
‚îú‚îÄ‚îÄ Authentication/
‚îÇ   ‚îî‚îÄ‚îÄ ClerkOAuthTokenHandler.cs  ‚ùå DELETE (replaced by Andy.Auth)
‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îî‚îÄ‚îÄ DynamicClientRegistrationController.cs  ‚ùå DELETE
‚îî‚îÄ‚îÄ Program.cs  ‚úèÔ∏è SIMPLIFY
```

### New Lexipro Setup:

**1. Install Andy.Auth:**

```bash
cd /path/to/lexipro/src/Lexipro.Api
dotnet add package Andy.Auth --version 1.0.0-beta
```

**2. Update appsettings.json:**

```json
{
  "AndyAuth": {
    "Provider": "AndyAuth",
    "Authority": "https://auth.rivoli.ai",
    "Audience": "lexipro-api",
    "RequireHttpsMetadata": false  // Only for development
  },
  "Mcp": {
    "ServerUrl": "https://lexipro-api.rivoli.ai",
    "McpPath": "/mcp"
  }
}
```

**3. Update Program.cs:**

**BEFORE (70+ lines of auth configuration):**
```csharp
// All the JWT, Clerk, MCP auth configuration...
```

**AFTER (5 lines!):**
```csharp
using Andy.Auth.Extensions;

// Replace all authentication code with:
builder.Services.AddAndyAuth(builder.Configuration);

// MCP server still works the same
builder.Services
    .AddMcpServer()
    .WithHttpTransport()
    .WithToolsFromAssembly();
```

**4. Update MCP Tools:**

```csharp
// LexiproTools.cs - NO CHANGES NEEDED!
public class LexiproTools
{
    private readonly ICurrentUserService _currentUser; // Andy.Auth.Services

    public LexiproTools(ICurrentUserService currentUser, ...)
    {
        _currentUser = currentUser;
    }

    [McpServerTool]
    public async Task<List<Book>> ListBooks()
    {
        var userId = await _currentUser.GetUserIdAsync();
        // ... rest of code unchanged
    }
}
```

## Step 6: Next Steps

### Immediate (This Week):

1. ‚úÖ Push to GitHub: `git push origin main`
2. üöß Build Andy.Auth.Server (or use OpenIddict template)
3. üì¶ Publish Andy.Auth v1.0.0-beta to GitHub Packages
4. ‚úèÔ∏è Migrate Lexipro.Api to use Andy.Auth

### Short-term (Next 2 Weeks):

1. Deploy Andy.Auth.Server to production (auth.rivoli.ai)
2. Test authentication flow with Claude Desktop
3. Update Lexipro deployment to point to new auth server
4. Remove Clerk dependency (or keep as external IDP)

### Long-term (Next Month):

1. Add Azure AD multi-tenant support
2. Create andy-docs public repo (open source Lexipro)
3. Add more authentication providers (Google, GitHub)
4. Build admin dashboard for managing OAuth clients

## Architecture Benefits

### What You Get:

‚úÖ **Single Sign-On** - One user account across all Rivoli AI products
‚úÖ **Provider Flexibility** - Switch between AndyAuth, Azure AD, Clerk easily
‚úÖ **Easy Onboarding** - New APIs just need `AddAndyAuth()`
‚úÖ **Open Source Ready** - Library can be open sourced
‚úÖ **Private Deployment** - Keep your integrations private

### Migration Path:

```
Current:
  Lexipro ‚Üí Clerk (hardcoded)

After Andy.Auth:
  Lexipro ‚Üí Andy.Auth (library) ‚Üí Andy Auth Server (your OAuth provider)
                                 ‚Üí OR Azure AD
                                 ‚Üí OR Clerk (as external IDP)

Future Products:
  Product2 ‚Üí Andy.Auth (same library) ‚Üí Andy Auth Server (same users!)
```

## Questions?

1. **Do I need to build Andy.Auth.Server immediately?**
   - No! You can use Andy.Auth with existing Clerk by setting `"Provider": "Clerk"`
   - Build the server when you're ready to own the OAuth flow

2. **Can I test Andy.Auth locally?**
   - Yes! Use the SampleApi project
   - Configure it with Clerk first, then switch to AndyAuth later

3. **How do I debug authentication issues?**
   - Andy.Auth logs all authentication events
   - Check logs for "AndyAuth:" prefixed messages
   - Use `ICurrentUserService` to inspect claims

## Resources

- [OpenIddict Documentation](https://documentation.openiddict.com/)
- [OAuth 2.0 Spec](https://oauth.net/2/)
- [MCP Authentication Guide](https://github.com/modelcontextprotocol/specification)

---

**Current Status:**
- ‚úÖ Andy.Auth library: READY FOR PRODUCTION
- üöß Andy.Auth.Server: NEEDS IMPLEMENTATION
- üì¶ NuGet Package: READY TO PUBLISH
- üìö Documentation: IN PROGRESS

**Created:** 2025-11-15
**Location:** /Users/samibengrine/Devel/rivoli-ai/andy-auth
