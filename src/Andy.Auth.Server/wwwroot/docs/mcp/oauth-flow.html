<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP OAuth 2.1 Flow - Andy Auth Documentation</title>
    <meta name="description" content="OAuth 2.1 flow for MCP clients">
    <link rel="stylesheet" href="/docs/css/docs.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/docs/images/favicon.png">
</head>
<body>
    <!-- Header -->
        <header class="docs-header">
        <div class="docs-header-inner">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="docs-mobile-toggle" id="sidebar-toggle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <a href="/docs/" class="docs-logo">
                    <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="8" fill="currentColor"/>
                        <path d="M8 24V8h6l4 8 4-8h6v16h-5V14l-3.5 7h-3L13 14v10H8z" fill="white"/>
                    </svg>
                    <span class="docs-logo-text">
                        <span class="docs-logo-title">Andy Auth</span>
                        <span class="docs-logo-subtitle">Documentation</span>
                    </span>
                    <span class="docs-version">v1.0</span>
                </a>
            </div>

            <div class="docs-search">
                <div class="docs-search-wrapper">
                    <svg class="docs-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="docs-search-input" placeholder="Search documentation..." data-search-trigger readonly>
                    <span class="docs-search-shortcut">Ctrl K</span>
                </div>
            </div>

            <div class="docs-header-actions">
                <button class="docs-header-btn" id="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                    </svg>
                </button>
                <a href="https://github.com/rivoli-ai/andy-auth" class="docs-header-btn" title="GitHub" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                    </svg>
                </a>
                <a href="/" class="docs-header-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    </svg>
                    <span>Back to App</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
        <aside class="docs-sidebar">
        <nav>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Getting Started</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/" class="docs-sidebar-link">Overview</a></li>
                    <li><a href="/docs/quickstart.html" class="docs-sidebar-link">Quick Start</a></li>
                    <li><a href="/docs/installation.html" class="docs-sidebar-link">Installation</a></li>
                    <li><a href="/docs/configuration.html" class="docs-sidebar-link">Configuration</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">MCP Integration <span class="badge badge-new">Important</span></div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/mcp/overview.html" class="docs-sidebar-link">MCP Overview</a></li>
                    <li><a href="/docs/mcp/oauth-flow.html" class="docs-sidebar-link active">OAuth 2.1 Flow</a></li>
                    <li><a href="/docs/mcp/claude-desktop.html" class="docs-sidebar-link">Claude Desktop</a></li>
                    <li><a href="/docs/mcp/chatgpt.html" class="docs-sidebar-link">ChatGPT</a></li>
                    <li><a href="/docs/mcp/vscode-extensions.html" class="docs-sidebar-link">VS Code Extensions</a></li>
                    <li><a href="/docs/mcp/dcr.html" class="docs-sidebar-link">Dynamic Client Registration</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">OAuth & OpenID Connect</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/oauth/concepts.html" class="docs-sidebar-link">Core Concepts</a></li>
                    <li><a href="/docs/oauth/authorization-code.html" class="docs-sidebar-link">Authorization Code Flow</a></li>
                    <li><a href="/docs/oauth/pkce.html" class="docs-sidebar-link">PKCE</a></li>
                    <li><a href="/docs/oauth/client-credentials.html" class="docs-sidebar-link">Client Credentials</a></li>
                    <li><a href="/docs/oauth/access-tokens.html" class="docs-sidebar-link">Access Tokens</a></li>
                    <li><a href="/docs/oauth/refresh-tokens.html" class="docs-sidebar-link">Refresh Tokens</a></li>
                    <li><a href="/docs/oauth/scopes.html" class="docs-sidebar-link">Scopes</a></li>
                    <li><a href="/docs/oauth/claims.html" class="docs-sidebar-link">Claims</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Tutorials</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/tutorials/python.html" class="docs-sidebar-link">Python</a></li>
                    <li><a href="/docs/tutorials/csharp.html" class="docs-sidebar-link">C# / .NET</a></li>
                    <li><a href="/docs/tutorials/javascript.html" class="docs-sidebar-link">JavaScript</a></li>
                    <li><a href="/docs/tutorials/typescript.html" class="docs-sidebar-link">TypeScript</a></li>
                    <li><a href="/docs/tutorials/java.html" class="docs-sidebar-link">Java</a></li>
                    <li><a href="/docs/tutorials/go.html" class="docs-sidebar-link">Go</a></li>
                    <li><a href="/docs/tutorials/rust.html" class="docs-sidebar-link">Rust</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">API Reference</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/api/endpoints.html" class="docs-sidebar-link">Endpoints Overview</a></li>
                    <li><a href="/docs/api/authorize.html" class="docs-sidebar-link">Authorization</a></li>
                    <li><a href="/docs/api/token.html" class="docs-sidebar-link">Token</a></li>
                    <li><a href="/docs/api/userinfo.html" class="docs-sidebar-link">UserInfo</a></li>
                    <li><a href="/docs/api/introspect.html" class="docs-sidebar-link">Introspection</a></li>
                    <li><a href="/docs/api/revoke.html" class="docs-sidebar-link">Revocation</a></li>
                    <li><a href="/docs/api/register.html" class="docs-sidebar-link">Client Registration</a></li>
                    <li><a href="/docs/api/discovery.html" class="docs-sidebar-link">Discovery</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Admin Dashboard <span class="badge badge-new">New</span></div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/admin/dashboard.html" class="docs-sidebar-link">Dashboard</a></li>
                    <li><a href="/docs/admin/users.html" class="docs-sidebar-link">Users</a></li>
                    <li><a href="/docs/admin/clients.html" class="docs-sidebar-link">Clients</a></li>
                    <li><a href="/docs/admin/tokens.html" class="docs-sidebar-link">Tokens</a></li>
                    <li><a href="/docs/admin/audit-logs.html" class="docs-sidebar-link">Audit Logs</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Deployment</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/deployment/railway.html" class="docs-sidebar-link">Railway</a></li>
                    <li><a href="/docs/deployment/docker.html" class="docs-sidebar-link">Docker</a></li>
                    <li><a href="/docs/deployment/production.html" class="docs-sidebar-link">Production</a></li>
                    <li><a href="/docs/deployment/azure.html" class="docs-sidebar-link">Azure</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Security</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/security/overview.html" class="docs-sidebar-link">Security Overview</a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="docs-main">
        <article class="docs-content">
            <nav class="docs-breadcrumb">
                <a href="/docs/">Docs</a>
                <span class="docs-breadcrumb-sep">/</span>
                <a href="/docs/mcp/overview.html">MCP Integration</a>
                <span class="docs-breadcrumb-sep">/</span>
                <span class="docs-breadcrumb-current">OAuth 2.1 Flow</span>
            </nav>

            <h1>MCP OAuth 2.1 Flow</h1>
            <p class="lead">
                A detailed guide to the OAuth 2.1 authentication flow specifically designed for AI assistants
                connecting to MCP-enabled services through Andy Auth.
            </p>

            <div class="callout callout-info">
                <div class="callout-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    OAuth 2.1 vs OAuth 2.0
                </div>
                <p>
                    OAuth 2.1 is the latest evolution of OAuth, consolidating best practices from OAuth 2.0 and its extensions.
                    For MCP clients, the key requirement is <strong>PKCE (Proof Key for Code Exchange)</strong>, which is mandatory
                    for all authorization code flows.
                </p>
            </div>

            <h2 id="flow-overview">Flow Overview</h2>

            <p>The MCP OAuth 2.1 flow consists of these main phases:</p>

            <ol>
                <li><strong>Discovery</strong> - Client discovers Andy Auth endpoints via OpenID Connect Discovery</li>
                <li><strong>Registration</strong> - Client registers dynamically (if not pre-configured)</li>
                <li><strong>Authorization</strong> - User authenticates and grants consent</li>
                <li><strong>Token Exchange</strong> - Client exchanges authorization code for tokens</li>
                <li><strong>API Access</strong> - Client uses access token to call MCP servers</li>
                <li><strong>Token Refresh</strong> - Client refreshes expired tokens</li>
            </ol>

            <h2 id="step-1-discovery">Step 1: Discovery</h2>

            <p>AI clients first discover Andy Auth's capabilities by fetching the OpenID Connect configuration:</p>

            <div class="endpoint">
                <span class="endpoint-method get">GET</span>
                <span class="endpoint-path">/.well-known/openid-configuration</span>
            </div>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">javascript</span>
                    <button class="code-block-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
                <pre><code class="language-javascript">// Discover OAuth endpoints
const discoveryUrl = 'https://auth.example.com/.well-known/openid-configuration';
const config = await fetch(discoveryUrl).then(r => r.json());

// Extract key endpoints
const {
    authorization_endpoint,
    token_endpoint,
    registration_endpoint,
    introspection_endpoint,
    revocation_endpoint
} = config;

console.log('Authorization:', authorization_endpoint);
console.log('Token:', token_endpoint);
console.log('Registration:', registration_endpoint);</code></pre>
            </div>

            <h2 id="step-2-pkce">Step 2: Generate PKCE Values</h2>

            <p>PKCE is mandatory for all MCP clients. Generate the code verifier and challenge before starting the authorization flow:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">javascript</span>
                    <button class="code-block-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
                <pre><code class="language-javascript">import crypto from 'crypto';

// Generate a cryptographically random code verifier (43-128 characters)
function generateCodeVerifier() {
    const buffer = crypto.randomBytes(64);
    return buffer.toString('base64url').substring(0, 128);
}

// Create the code challenge using SHA-256
async function generateCodeChallenge(verifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
}

// Generate PKCE pair
const codeVerifier = generateCodeVerifier();
const codeChallenge = await generateCodeChallenge(codeVerifier);

// Store codeVerifier securely - you'll need it for token exchange
sessionStorage.setItem('pkce_code_verifier', codeVerifier);</code></pre>
            </div>

            <div class="callout callout-warning">
                <div class="callout-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Security Note
                </div>
                <p>
                    The code verifier must be stored securely and never exposed to the user or transmitted until the token exchange.
                    Only the code challenge (derived from the verifier) is sent in the authorization request.
                </p>
            </div>

            <h2 id="step-3-authorization">Step 3: Authorization Request</h2>

            <p>Redirect the user to Andy Auth's authorization endpoint:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">javascript</span>
                    <button class="code-block-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
                <pre><code class="language-javascript">// Build authorization URL
const authUrl = new URL('https://auth.example.com/connect/authorize');

// Required parameters
authUrl.searchParams.set('client_id', 'claude-desktop');
authUrl.searchParams.set('response_type', 'code');
authUrl.searchParams.set('redirect_uri', 'http://localhost:3000/callback');
authUrl.searchParams.set('scope', 'openid profile email offline_access');

// PKCE parameters (required for MCP)
authUrl.searchParams.set('code_challenge', codeChallenge);
authUrl.searchParams.set('code_challenge_method', 'S256');

// State for CSRF protection
const state = crypto.randomBytes(32).toString('base64url');
sessionStorage.setItem('oauth_state', state);
authUrl.searchParams.set('state', state);

// Optional: nonce for OpenID Connect
const nonce = crypto.randomBytes(32).toString('base64url');
sessionStorage.setItem('oauth_nonce', nonce);
authUrl.searchParams.set('nonce', nonce);

// Redirect user to authorization page
window.location.href = authUrl.toString();</code></pre>
            </div>

            <h3 id="authorization-params">Authorization Parameters</h3>

            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Required</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>client_id</code></td>
                        <td>Yes</td>
                        <td>Pre-configured client ID (e.g., <code>claude-desktop</code>)</td>
                    </tr>
                    <tr>
                        <td><code>response_type</code></td>
                        <td>Yes</td>
                        <td>Must be <code>code</code> for authorization code flow</td>
                    </tr>
                    <tr>
                        <td><code>redirect_uri</code></td>
                        <td>Yes</td>
                        <td>URL to receive the authorization code</td>
                    </tr>
                    <tr>
                        <td><code>scope</code></td>
                        <td>Yes</td>
                        <td>Space-separated list of requested scopes</td>
                    </tr>
                    <tr>
                        <td><code>code_challenge</code></td>
                        <td>Yes</td>
                        <td>PKCE code challenge (Base64URL encoded)</td>
                    </tr>
                    <tr>
                        <td><code>code_challenge_method</code></td>
                        <td>Yes</td>
                        <td>Must be <code>S256</code> for SHA-256</td>
                    </tr>
                    <tr>
                        <td><code>state</code></td>
                        <td>Recommended</td>
                        <td>Random value for CSRF protection</td>
                    </tr>
                    <tr>
                        <td><code>nonce</code></td>
                        <td>Recommended</td>
                        <td>Random value for ID token validation</td>
                    </tr>
                </tbody>
            </table>

            <h2 id="step-4-user-consent">Step 4: User Authentication & Consent</h2>

            <p>Andy Auth displays the login page and consent screen. After the user authenticates and grants consent,
            they are redirected back to your application:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">text</span>
                </div>
                <pre><code class="language-none">// Success callback
http://localhost:3000/callback?code=abc123xyz&state=original_state_value

// Error callback
http://localhost:3000/callback?error=access_denied&error_description=User+denied+consent</code></pre>
            </div>

            <h2 id="step-5-token-exchange">Step 5: Token Exchange</h2>

            <p>Exchange the authorization code for tokens. Include the original code verifier:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">javascript</span>
                    <button class="code-block-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
                <pre><code class="language-javascript">// Handle callback and extract authorization code
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
const returnedState = urlParams.get('state');

// Verify state matches
const savedState = sessionStorage.getItem('oauth_state');
if (returnedState !== savedState) {
    throw new Error('State mismatch - possible CSRF attack');
}

// Retrieve stored code verifier
const codeVerifier = sessionStorage.getItem('pkce_code_verifier');

// Exchange code for tokens
const tokenResponse = await fetch('https://auth.example.com/connect/token', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: 'claude-desktop',
        code: code,
        redirect_uri: 'http://localhost:3000/callback',
        code_verifier: codeVerifier
    })
});

const tokens = await tokenResponse.json();

// tokens contains:
// {
//   "access_token": "eyJhbG...",
//   "token_type": "Bearer",
//   "expires_in": 3600,
//   "refresh_token": "rt_abc123...",
//   "id_token": "eyJhbG...",
//   "scope": "openid profile email offline_access"
// }</code></pre>
            </div>

            <h2 id="step-6-api-calls">Step 6: Making API Calls</h2>

            <p>Use the access token to authenticate requests to MCP servers:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">javascript</span>
                    <button class="code-block-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
                <pre><code class="language-javascript">// Call MCP server with access token
const mcpResponse = await fetch('https://mcp-server.example.com/api/resource', {
    method: 'GET',
    headers: {
        'Authorization': `Bearer ${tokens.access_token}`,
        'Content-Type': 'application/json'
    }
});

if (mcpResponse.status === 401) {
    // Token expired, attempt refresh
    await refreshAccessToken();
}

const data = await mcpResponse.json();</code></pre>
            </div>

            <h2 id="step-7-token-refresh">Step 7: Token Refresh</h2>

            <p>When the access token expires, use the refresh token to obtain a new one:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">javascript</span>
                    <button class="code-block-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
                <pre><code class="language-javascript">async function refreshAccessToken() {
    const refreshToken = localStorage.getItem('refresh_token');

    const response = await fetch('https://auth.example.com/connect/token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
            grant_type: 'refresh_token',
            client_id: 'claude-desktop',
            refresh_token: refreshToken
        })
    });

    if (!response.ok) {
        // Refresh token expired or revoked
        // Redirect user to re-authenticate
        initiateAuthorizationFlow();
        return;
    }

    const newTokens = await response.json();

    // Store new tokens
    localStorage.setItem('access_token', newTokens.access_token);
    if (newTokens.refresh_token) {
        // Some servers rotate refresh tokens
        localStorage.setItem('refresh_token', newTokens.refresh_token);
    }

    return newTokens;
}</code></pre>
            </div>

            <h2 id="token-introspection">Token Introspection (for MCP Servers)</h2>

            <p>MCP servers validate tokens using the introspection endpoint:</p>

            <div class="endpoint">
                <span class="endpoint-method post">POST</span>
                <span class="endpoint-path">/connect/introspect</span>
            </div>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">python</span>
                    <button class="code-block-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
                <pre><code class="language-python">import requests
from functools import wraps

def validate_access_token(token: str) -> dict:
    """Validate access token via introspection endpoint."""
    response = requests.post(
        'https://auth.example.com/connect/introspect',
        data={
            'token': token,
            'token_type_hint': 'access_token'
        },
        # Use client credentials for authentication
        auth=('mcp-server-client-id', 'mcp-server-client-secret')
    )

    result = response.json()

    if not result.get('active'):
        raise ValueError('Token is inactive or expired')

    return {
        'sub': result.get('sub'),
        'client_id': result.get('client_id'),
        'scope': result.get('scope', '').split(),
        'exp': result.get('exp')
    }

# Flask middleware example
def require_oauth(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        auth_header = request.headers.get('Authorization', '')
        if not auth_header.startswith('Bearer '):
            return {'error': 'Missing bearer token'}, 401

        token = auth_header[7:]  # Remove 'Bearer ' prefix

        try:
            token_info = validate_access_token(token)
            g.user_id = token_info['sub']
            g.scopes = token_info['scope']
        except ValueError as e:
            return {'error': str(e)}, 401

        return f(*args, **kwargs)
    return decorated</code></pre>
            </div>

            <h2 id="token-revocation">Token Revocation</h2>

            <p>Revoke tokens when the user logs out:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">javascript</span>
                    <button class="code-block-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy
                    </button>
                </div>
                <pre><code class="language-javascript">async function logout() {
    const accessToken = localStorage.getItem('access_token');
    const refreshToken = localStorage.getItem('refresh_token');

    // Revoke refresh token (also invalidates associated access tokens)
    await fetch('https://auth.example.com/connect/revoke', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
            token: refreshToken,
            token_type_hint: 'refresh_token',
            client_id: 'claude-desktop'
        })
    });

    // Clear local storage
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');

    // Redirect to home or login page
    window.location.href = '/';
}</code></pre>
            </div>

            <h2 id="error-handling">Error Handling</h2>

            <p>Common OAuth errors and how to handle them:</p>

            <table>
                <thead>
                    <tr>
                        <th>Error</th>
                        <th>Description</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>invalid_client</code></td>
                        <td>Unknown client ID</td>
                        <td>Verify client ID is correctly configured</td>
                    </tr>
                    <tr>
                        <td><code>invalid_grant</code></td>
                        <td>Code expired or already used</td>
                        <td>Restart authorization flow</td>
                    </tr>
                    <tr>
                        <td><code>invalid_request</code></td>
                        <td>Missing or invalid parameter</td>
                        <td>Check all required parameters are present</td>
                    </tr>
                    <tr>
                        <td><code>access_denied</code></td>
                        <td>User denied consent</td>
                        <td>Inform user and optionally retry</td>
                    </tr>
                    <tr>
                        <td><code>invalid_scope</code></td>
                        <td>Requested scope not allowed</td>
                        <td>Request only allowed scopes</td>
                    </tr>
                </tbody>
            </table>

            <h2 id="troubleshooting">Troubleshooting</h2>

            <div class="callout callout-warning">
                <div class="callout-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Common Issues
                </div>
                <ul>
                    <li><strong>PKCE mismatch</strong>: Ensure the code verifier is stored and retrieved correctly between authorization and token exchange</li>
                    <li><strong>Redirect URI mismatch</strong>: The redirect URI in the token request must exactly match the one in the authorization request</li>
                    <li><strong>State validation failure</strong>: Make sure state is stored before redirect and validated after callback</li>
                    <li><strong>Token expired</strong>: Implement automatic token refresh before making API calls</li>
                </ul>
            </div>

            <h2 id="next-steps">Next Steps</h2>

            <div class="docs-cards">
                <a href="/docs/mcp/claude-desktop.html" class="docs-card">
                    <div class="docs-card-title">Claude Desktop Setup</div>
                    <div class="docs-card-desc">Configure Claude Desktop to use Andy Auth for MCP authentication.</div>
                </a>
                <a href="/docs/mcp/dcr.html" class="docs-card">
                    <div class="docs-card-title">Dynamic Client Registration</div>
                    <div class="docs-card-desc">Learn how to register OAuth clients automatically.</div>
                </a>
                <a href="/docs/oauth/pkce.html" class="docs-card">
                    <div class="docs-card-title">PKCE Deep Dive</div>
                    <div class="docs-card-desc">Understand PKCE implementation details and security benefits.</div>
                </a>
            </div>

            <nav class="docs-page-nav">
                <a href="/docs/mcp/overview.html" class="docs-page-nav-link prev">
                    <span class="docs-page-nav-label">Previous</span>
                    <span class="docs-page-nav-title">MCP Overview</span>
                </a>
                <a href="/docs/mcp/claude-desktop.html" class="docs-page-nav-link next">
                    <span class="docs-page-nav-label">Next</span>
                    <span class="docs-page-nav-title">Claude Desktop</span>
                </a>
            </nav>
        </article>

        <aside class="docs-toc">
            <div class="docs-toc-title">On this page</div>
            <ul class="docs-toc-list"></ul>
        </aside>
    </main>

    <div class="docs-search-modal" id="search-modal">
        <div class="docs-search-modal-content">
            <input type="text" class="docs-search-modal-input" id="search-modal-input" placeholder="Search documentation...">
            <div class="docs-search-results" id="search-results"></div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-docker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-http.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="/docs/js/docs.js"></script>
</body>
</html>
