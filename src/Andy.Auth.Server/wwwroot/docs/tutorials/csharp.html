<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C# / .NET Tutorial - Andy Auth Documentation</title>
    <meta name="description" content="C# and .NET OAuth integration tutorial">
    <link rel="stylesheet" href="/docs/css/docs.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/docs/images/favicon.png">
</head>
<body>
    <header class="docs-header">
        <div class="docs-header-inner">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="docs-mobile-toggle" id="sidebar-toggle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <a href="/docs/" class="docs-logo">
                    <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="8" fill="currentColor"/>
                        <path d="M8 24V8h6l4 8 4-8h6v16h-5V14l-3.5 7h-3L13 14v10H8z" fill="white"/>
                    </svg>
                    <span class="docs-logo-text">
                        <span class="docs-logo-title">Andy Auth</span>
                        <span class="docs-logo-subtitle">Documentation</span>
                    </span>
                    <span class="docs-version">v1.0</span>
                </a>
            </div>

            <div class="docs-search">
                <div class="docs-search-wrapper">
                    <svg class="docs-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="docs-search-input" placeholder="Search documentation..." data-search-trigger readonly>
                    <span class="docs-search-shortcut">Ctrl K</span>
                </div>
            </div>

            <div class="docs-header-actions">
                <button class="docs-header-btn" id="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                    </svg>
                </button>
                <a href="https://github.com/rivoli-ai/andy-auth" class="docs-header-btn" title="GitHub" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                    </svg>
                </a>
                <a href="/" class="docs-header-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    </svg>
                    <span>Back to App</span>
                </a>
            </div>
        </div>
    </header>

    <aside class="docs-sidebar">
        <nav>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Getting Started</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/" class="docs-sidebar-link">Overview</a></li>
                    <li><a href="/docs/quickstart.html" class="docs-sidebar-link">Quick Start</a></li>
                    <li><a href="/docs/installation.html" class="docs-sidebar-link">Installation</a></li>
                    <li><a href="/docs/configuration.html" class="docs-sidebar-link">Configuration</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">MCP Integration <span class="badge badge-new">Important</span></div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/mcp/overview.html" class="docs-sidebar-link">MCP Overview</a></li>
                    <li><a href="/docs/mcp/oauth-flow.html" class="docs-sidebar-link">OAuth 2.1 Flow</a></li>
                    <li><a href="/docs/mcp/claude-desktop.html" class="docs-sidebar-link">Claude Desktop</a></li>
                    <li><a href="/docs/mcp/chatgpt.html" class="docs-sidebar-link">ChatGPT</a></li>
                    <li><a href="/docs/mcp/vscode-extensions.html" class="docs-sidebar-link">VS Code Extensions</a></li>
                    <li><a href="/docs/mcp/dcr.html" class="docs-sidebar-link">Dynamic Client Registration</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">OAuth & OpenID Connect</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/oauth/concepts.html" class="docs-sidebar-link">Core Concepts</a></li>
                    <li><a href="/docs/oauth/authorization-code.html" class="docs-sidebar-link">Authorization Code Flow</a></li>
                    <li><a href="/docs/oauth/pkce.html" class="docs-sidebar-link">PKCE</a></li>
                    <li><a href="/docs/oauth/client-credentials.html" class="docs-sidebar-link">Client Credentials</a></li>
                    <li><a href="/docs/oauth/access-tokens.html" class="docs-sidebar-link">Access Tokens</a></li>
                    <li><a href="/docs/oauth/refresh-tokens.html" class="docs-sidebar-link">Refresh Tokens</a></li>
                    <li><a href="/docs/oauth/scopes.html" class="docs-sidebar-link">Scopes</a></li>
                    <li><a href="/docs/oauth/claims.html" class="docs-sidebar-link">Claims</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Tutorials</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/tutorials/python.html" class="docs-sidebar-link">Python</a></li>
                    <li><a href="/docs/tutorials/csharp.html" class="docs-sidebar-link active">C# / .NET</a></li>
                    <li><a href="/docs/tutorials/javascript.html" class="docs-sidebar-link">JavaScript</a></li>
                    <li><a href="/docs/tutorials/typescript.html" class="docs-sidebar-link">TypeScript</a></li>
                    <li><a href="/docs/tutorials/java.html" class="docs-sidebar-link">Java</a></li>
                    <li><a href="/docs/tutorials/go.html" class="docs-sidebar-link">Go</a></li>
                    <li><a href="/docs/tutorials/rust.html" class="docs-sidebar-link">Rust</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">API Reference</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/api/endpoints.html" class="docs-sidebar-link">Endpoints Overview</a></li>
                    <li><a href="/docs/api/authorize.html" class="docs-sidebar-link">Authorization</a></li>
                    <li><a href="/docs/api/token.html" class="docs-sidebar-link">Token</a></li>
                    <li><a href="/docs/api/userinfo.html" class="docs-sidebar-link">UserInfo</a></li>
                    <li><a href="/docs/api/introspect.html" class="docs-sidebar-link">Introspection</a></li>
                    <li><a href="/docs/api/revoke.html" class="docs-sidebar-link">Revocation</a></li>
                    <li><a href="/docs/api/register.html" class="docs-sidebar-link">Client Registration</a></li>
                    <li><a href="/docs/api/discovery.html" class="docs-sidebar-link">Discovery</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Admin Dashboard <span class="badge badge-new">New</span></div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/admin/dashboard.html" class="docs-sidebar-link">Dashboard</a></li>
                    <li><a href="/docs/admin/users.html" class="docs-sidebar-link">Users</a></li>
                    <li><a href="/docs/admin/clients.html" class="docs-sidebar-link">Clients</a></li>
                    <li><a href="/docs/admin/tokens.html" class="docs-sidebar-link">Tokens</a></li>
                    <li><a href="/docs/admin/audit-logs.html" class="docs-sidebar-link">Audit Logs</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Deployment</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/deployment/railway.html" class="docs-sidebar-link">Railway</a></li>
                    <li><a href="/docs/deployment/docker.html" class="docs-sidebar-link">Docker</a></li>
                    <li><a href="/docs/deployment/production.html" class="docs-sidebar-link">Production</a></li>
                    <li><a href="/docs/deployment/azure.html" class="docs-sidebar-link">Azure</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Security</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/security/overview.html" class="docs-sidebar-link">Security Overview</a></li>
                </ul>
            </div>
        </nav>
    </aside>

        <main class="docs-main">
            <article class="docs-content">
                <div class="docs-breadcrumb">
                    <a href="../">Docs</a>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    <a href="#">Tutorials</a>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    <span>C# / .NET</span>
                </div>

                <h1>C# / .NET OAuth Integration</h1>
                <p class="docs-lead">Integrate Andy Auth into your .NET applications using ASP.NET Core, minimal APIs, or console applications.</p>

                <div class="docs-callout docs-callout-info">
                    <div class="docs-callout-title">Prerequisites</div>
                    <p>This tutorial assumes you have .NET 8+ installed and are familiar with ASP.NET Core basics.</p>
                </div>

                <h2 id="packages">Required NuGet Packages</h2>
                <p>Install the required packages for OAuth integration:</p>

                <div class="code-block">
                    <div class="code-block-header">
                        <span class="code-block-lang">Shell</span>
                        <button class="code-block-copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                Copy
                            </button>
                    </div>
                    <pre><code class="language-bash"># For ASP.NET Core web applications
dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect

# For token validation in APIs
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer

# Optional: For HTTP client operations
dotnet add package Microsoft.Extensions.Http</code></pre>
                </div>

                <h2 id="aspnet-core">ASP.NET Core Web Application</h2>
                <p>Configure OpenID Connect authentication in your ASP.NET Core application:</p>

                <div class="code-block">
                    <div class="code-block-header">
                        <span class="code-block-lang">C# - Program.cs</span>
                        <button class="code-block-copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                Copy
                            </button>
                    </div>
                    <pre><code class="language-csharp">using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Authentication.OpenIdConnect;
using Microsoft.IdentityModel.Protocols.OpenIdConnect;

var builder = WebApplication.CreateBuilder(args);

// Add authentication services
builder.Services.AddAuthentication(options =>
{
    options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
})
.AddCookie(options =>
{
    options.Cookie.Name = "MyApp.Auth";
    options.Cookie.HttpOnly = true;
    options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
    options.ExpireTimeSpan = TimeSpan.FromHours(8);
})
.AddOpenIdConnect(options =>
{
    // Andy Auth server configuration
    options.Authority = "https://your-andy-auth-server.com";
    options.ClientId = "your-client-id";
    options.ClientSecret = "your-client-secret";

    // OAuth settings
    options.ResponseType = OpenIdConnectResponseType.Code;
    options.SaveTokens = true;
    options.GetClaimsFromUserInfoEndpoint = true;

    // PKCE is automatically enabled for authorization code flow
    options.UsePkce = true;

    // Scopes
    options.Scope.Clear();
    options.Scope.Add("openid");
    options.Scope.Add("profile");
    options.Scope.Add("email");

    // Token validation
    options.TokenValidationParameters = new()
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true
    };

    // Events for customization
    options.Events = new OpenIdConnectEvents
    {
        OnTokenValidated = context =>
        {
            // Custom logic after token validation
            var claims = context.Principal?.Claims;
            // Log or process claims
            return Task.CompletedTask;
        },
        OnRemoteFailure = context =>
        {
            context.Response.Redirect("/error?message=" +
                Uri.EscapeDataString(context.Failure?.Message ?? "Unknown error"));
            context.HandleResponse();
            return Task.CompletedTask;
        }
    };
});

builder.Services.AddAuthorization();
builder.Services.AddControllersWithViews();

var app = builder.Build();

app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();

app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");

app.Run();</code></pre>
                </div>

                <h2 id="controller">Authentication Controller</h2>
                <p>Create a controller to handle login, logout, and callback:</p>

                <div class="code-block">
                    <div class="code-block-header">
                        <span class="code-block-lang">C# - AccountController.cs</span>
                        <button class="code-block-copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                Copy
                            </button>
                    </div>
                    <pre><code class="language-csharp">using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Authentication.OpenIdConnect;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

[Route("[controller]")]
public class AccountController : Controller
{
    [HttpGet("login")]
    public IActionResult Login(string? returnUrl = null)
    {
        var redirectUrl = Url.Action("Index", "Home");
        if (!string.IsNullOrEmpty(returnUrl) && Url.IsLocalUrl(returnUrl))
        {
            redirectUrl = returnUrl;
        }

        return Challenge(new AuthenticationProperties
        {
            RedirectUri = redirectUrl
        }, OpenIdConnectDefaults.AuthenticationScheme);
    }

    [HttpGet("logout")]
    [Authorize]
    public async Task&lt;IActionResult&gt; Logout()
    {
        await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
        await HttpContext.SignOutAsync(OpenIdConnectDefaults.AuthenticationScheme);

        return RedirectToAction("Index", "Home");
    }

    [HttpGet("profile")]
    [Authorize]
    public IActionResult Profile()
    {
        var claims = User.Claims.Select(c => new { c.Type, c.Value });
        return Json(claims);
    }

    [HttpGet("tokens")]
    [Authorize]
    public async Task&lt;IActionResult&gt; Tokens()
    {
        var accessToken = await HttpContext.GetTokenAsync("access_token");
        var idToken = await HttpContext.GetTokenAsync("id_token");
        var refreshToken = await HttpContext.GetTokenAsync("refresh_token");

        return Json(new
        {
            AccessToken = accessToken?[..Math.Min(50, accessToken.Length)] + "...",
            IdToken = idToken?[..Math.Min(50, idToken.Length)] + "...",
            HasRefreshToken = !string.IsNullOrEmpty(refreshToken)
        });
    }
}</code></pre>
                </div>

                <h2 id="api-protection">Protecting an API with JWT Bearer</h2>
                <p>For APIs that receive tokens from clients, use JWT Bearer authentication:</p>

                <div class="code-block">
                    <div class="code-block-header">
                        <span class="code-block-lang">C# - API Program.cs</span>
                        <button class="code-block-copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                Copy
                            </button>
                    </div>
                    <pre><code class="language-csharp">using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.Authority = "https://your-andy-auth-server.com";
        options.Audience = "your-api-audience";

        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ClockSkew = TimeSpan.FromMinutes(5)
        };

        // Optional: Handle token validation events
        options.Events = new JwtBearerEvents
        {
            OnAuthenticationFailed = context =>
            {
                if (context.Exception is SecurityTokenExpiredException)
                {
                    context.Response.Headers.Append(
                        "Token-Expired", "true");
                }
                return Task.CompletedTask;
            },
            OnTokenValidated = context =>
            {
                // Log successful authentication
                var userId = context.Principal?.FindFirst("sub")?.Value;
                Console.WriteLine($"User {userId} authenticated");
                return Task.CompletedTask;
            }
        };
    });

builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("ReadAccess", policy =>
        policy.RequireClaim("scope", "read"));
    options.AddPolicy("WriteAccess", policy =>
        policy.RequireClaim("scope", "write"));
});

var app = builder.Build();

app.UseAuthentication();
app.UseAuthorization();

// Protected API endpoints
app.MapGet("/api/data", [Authorize] (HttpContext context) =>
{
    var userId = context.User.FindFirst("sub")?.Value;
    return Results.Ok(new { Message = "Protected data", UserId = userId });
});

app.MapGet("/api/admin", [Authorize(Policy = "WriteAccess")] () =>
{
    return Results.Ok(new { Message = "Admin only data" });
});

app.Run();</code></pre>
                </div>

                <h2 id="mcp-server">MCP Server Implementation</h2>
                <p>Build an MCP server in .NET that validates tokens from AI assistants:</p>

                <div class="code-block">
                    <div class="code-block-header">
                        <span class="code-block-lang">C# - MCPServer.cs</span>
                        <button class="code-block-copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                Copy
                            </button>
                    </div>
                    <pre><code class="language-csharp">using System.Net.Http.Headers;
using System.Text.Json;
using Microsoft.AspNetCore.Authentication.JwtBearer;

var builder = WebApplication.CreateBuilder(args);

// Configure JWT authentication for MCP
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.Authority = "https://your-andy-auth-server.com";
        options.TokenValidationParameters = new()
        {
            ValidateAudience = true,
            ValidAudiences = new[] { "mcp-server", "your-api" },
            ValidateIssuer = true,
            ValidateLifetime = true
        };
    });

builder.Services.AddHttpClient("TokenIntrospection", client =>
{
    client.BaseAddress = new Uri("https://your-andy-auth-server.com");
});

var app = builder.Build();

app.UseAuthentication();
app.UseAuthorization();

// MCP Tool: Get user information
app.MapPost("/mcp/tools/get_user_info", [Authorize] async (
    HttpContext context,
    IHttpClientFactory httpClientFactory) =>
{
    var userId = context.User.FindFirst("sub")?.Value;
    var email = context.User.FindFirst("email")?.Value;
    var name = context.User.FindFirst("name")?.Value;

    return Results.Ok(new
    {
        tool = "get_user_info",
        result = new
        {
            userId,
            email,
            name,
            authenticated = true
        }
    });
});

// MCP Tool: Execute a query (example)
app.MapPost("/mcp/tools/query_database", [Authorize] async (
    HttpContext context,
    QueryRequest request) =>
{
    var userId = context.User.FindFirst("sub")?.Value;

    // Verify user has permission for this query
    var scopes = context.User.FindFirst("scope")?.Value?.Split(' ') ?? [];
    if (!scopes.Contains("database:read"))
    {
        return Results.Forbid();
    }

    // Execute query (simplified example)
    var result = await ExecuteQuery(request.Query, userId);

    return Results.Ok(new
    {
        tool = "query_database",
        result
    });
});

// Token introspection endpoint for debugging
app.MapPost("/mcp/introspect", async (
    HttpContext context,
    IHttpClientFactory httpClientFactory) =>
{
    var authHeader = context.Request.Headers.Authorization.FirstOrDefault();
    if (string.IsNullOrEmpty(authHeader) || !authHeader.StartsWith("Bearer "))
    {
        return Results.Unauthorized();
    }

    var token = authHeader["Bearer ".Length..];
    var client = httpClientFactory.CreateClient("TokenIntrospection");

    var response = await client.PostAsync("/connect/introspect",
        new FormUrlEncodedContent(new Dictionary&lt;string, string&gt;
        {
            ["token"] = token,
            ["client_id"] = "mcp-server",
            ["client_secret"] = "server-secret"
        }));

    var result = await response.Content.ReadFromJsonAsync&lt;JsonElement&gt;();
    return Results.Ok(result);
});

app.Run();

record QueryRequest(string Query);

static Task&lt;object&gt; ExecuteQuery(string query, string? userId)
{
    // Implement your query logic here
    return Task.FromResult&lt;object&gt;(new { rows = new[] { "example" } });
}</code></pre>
                </div>

                <h2 id="client-credentials">Client Credentials Flow</h2>
                <p>For service-to-service authentication without user interaction:</p>

                <div class="code-block">
                    <div class="code-block-header">
                        <span class="code-block-lang">C# - ServiceClient.cs</span>
                        <button class="code-block-copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                Copy
                            </button>
                    </div>
                    <pre><code class="language-csharp">using System.Net.Http.Headers;
using System.Text.Json;

public class AndyAuthServiceClient
{
    private readonly HttpClient _httpClient;
    private readonly string _clientId;
    private readonly string _clientSecret;
    private readonly string _tokenEndpoint;

    private string? _accessToken;
    private DateTime _tokenExpiry = DateTime.MinValue;

    public AndyAuthServiceClient(
        HttpClient httpClient,
        string authority,
        string clientId,
        string clientSecret)
    {
        _httpClient = httpClient;
        _clientId = clientId;
        _clientSecret = clientSecret;
        _tokenEndpoint = $"{authority.TrimEnd('/')}/connect/token";
    }

    public async Task&lt;string&gt; GetAccessTokenAsync(
        string[] scopes,
        CancellationToken cancellationToken = default)
    {
        // Return cached token if still valid
        if (_accessToken != null && DateTime.UtcNow < _tokenExpiry.AddMinutes(-5))
        {
            return _accessToken;
        }

        var request = new HttpRequestMessage(HttpMethod.Post, _tokenEndpoint)
        {
            Content = new FormUrlEncodedContent(new Dictionary&lt;string, string&gt;
            {
                ["grant_type"] = "client_credentials",
                ["client_id"] = _clientId,
                ["client_secret"] = _clientSecret,
                ["scope"] = string.Join(" ", scopes)
            })
        };

        var response = await _httpClient.SendAsync(request, cancellationToken);
        response.EnsureSuccessStatusCode();

        var json = await response.Content.ReadFromJsonAsync&lt;JsonElement&gt;(
            cancellationToken: cancellationToken);

        _accessToken = json.GetProperty("access_token").GetString()
            ?? throw new InvalidOperationException("No access token in response");

        var expiresIn = json.GetProperty("expires_in").GetInt32();
        _tokenExpiry = DateTime.UtcNow.AddSeconds(expiresIn);

        return _accessToken;
    }

    public async Task&lt;T&gt; CallApiAsync&lt;T&gt;(
        string url,
        string[] scopes,
        CancellationToken cancellationToken = default)
    {
        var token = await GetAccessTokenAsync(scopes, cancellationToken);

        var request = new HttpRequestMessage(HttpMethod.Get, url);
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

        var response = await _httpClient.SendAsync(request, cancellationToken);
        response.EnsureSuccessStatusCode();

        return await response.Content.ReadFromJsonAsync&lt;T&gt;(
            cancellationToken: cancellationToken)
            ?? throw new InvalidOperationException("Empty response");
    }
}

// Usage in Program.cs or Startup.cs
builder.Services.AddSingleton(sp =>
{
    var httpClient = sp.GetRequiredService&lt;IHttpClientFactory&gt;()
        .CreateClient("AndyAuth");

    return new AndyAuthServiceClient(
        httpClient,
        authority: "https://your-andy-auth-server.com",
        clientId: "service-client",
        clientSecret: "service-secret");
});</code></pre>
                </div>

                <h2 id="dcr">Dynamic Client Registration</h2>
                <p>Register OAuth clients programmatically:</p>

                <div class="code-block">
                    <div class="code-block-header">
                        <span class="code-block-lang">C# - DynamicRegistration.cs</span>
                        <button class="code-block-copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                Copy
                            </button>
                    </div>
                    <pre><code class="language-csharp">using System.Text.Json;
using System.Text.Json.Serialization;

public class DynamicClientRegistration
{
    private readonly HttpClient _httpClient;
    private readonly string _registrationEndpoint;

    public DynamicClientRegistration(HttpClient httpClient, string authority)
    {
        _httpClient = httpClient;
        _registrationEndpoint = $"{authority.TrimEnd('/')}/connect/register";
    }

    public async Task&lt;ClientRegistrationResponse&gt; RegisterClientAsync(
        ClientRegistrationRequest request,
        CancellationToken cancellationToken = default)
    {
        var json = JsonSerializer.Serialize(request, new JsonSerializerOptions
        {
            PropertyNamingPolicy = JsonNamingPolicy.SnakeCaseLower,
            DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
        });

        var httpRequest = new HttpRequestMessage(HttpMethod.Post, _registrationEndpoint)
        {
            Content = new StringContent(json, System.Text.Encoding.UTF8, "application/json")
        };

        var response = await _httpClient.SendAsync(httpRequest, cancellationToken);

        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync(cancellationToken);
            throw new InvalidOperationException($"Registration failed: {error}");
        }

        return await response.Content.ReadFromJsonAsync&lt;ClientRegistrationResponse&gt;(
            new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.SnakeCaseLower },
            cancellationToken)
            ?? throw new InvalidOperationException("Empty response");
    }
}

public record ClientRegistrationRequest
{
    public required string[] RedirectUris { get; init; }
    public string? ClientName { get; init; }
    public string? ClientUri { get; init; }
    public string? LogoUri { get; init; }
    public string[]? GrantTypes { get; init; }
    public string[]? ResponseTypes { get; init; }
    public string? Scope { get; init; }
    public string? TokenEndpointAuthMethod { get; init; }
}

public record ClientRegistrationResponse
{
    public required string ClientId { get; init; }
    public string? ClientSecret { get; init; }
    public DateTime? ClientSecretExpiresAt { get; init; }
    public required string[] RedirectUris { get; init; }
    public string? ClientName { get; init; }
    public string? RegistrationAccessToken { get; init; }
    public string? RegistrationClientUri { get; init; }
}

// Usage example
var registration = new DynamicClientRegistration(
    httpClient,
    "https://your-andy-auth-server.com");

var client = await registration.RegisterClientAsync(new ClientRegistrationRequest
{
    RedirectUris = new[] { "https://myapp.com/callback" },
    ClientName = "My MCP Application",
    GrantTypes = new[] { "authorization_code", "refresh_token" },
    ResponseTypes = new[] { "code" },
    Scope = "openid profile email mcp:tools",
    TokenEndpointAuthMethod = "client_secret_post"
});

Console.WriteLine($"Client ID: {client.ClientId}");
Console.WriteLine($"Client Secret: {client.ClientSecret}");</code></pre>
                </div>

                <h2 id="testing">Testing Authentication</h2>
                <p>Unit testing your authentication setup:</p>

                <div class="code-block">
                    <div class="code-block-header">
                        <span class="code-block-lang">C# - AuthTests.cs</span>
                        <button class="code-block-copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                Copy
                            </button>
                    </div>
                    <pre><code class="language-csharp">using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.AspNetCore.TestHost;
using Microsoft.Extensions.DependencyInjection;
using System.Security.Claims;

public class AuthenticationTests : IClassFixture&lt;WebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Program&gt; _factory;

    public AuthenticationTests(WebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
    }

    [Fact]
    public async Task ProtectedEndpoint_WithoutToken_ReturnsUnauthorized()
    {
        var client = _factory.CreateClient();

        var response = await client.GetAsync("/api/data");

        Assert.Equal(System.Net.HttpStatusCode.Unauthorized, response.StatusCode);
    }

    [Fact]
    public async Task ProtectedEndpoint_WithValidToken_ReturnsOk()
    {
        var client = _factory.WithWebHostBuilder(builder =>
        {
            builder.ConfigureTestServices(services =>
            {
                services.AddAuthentication("Test")
                    .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                        "Test", options => { });
            });
        }).CreateClient();

        client.DefaultRequestHeaders.Authorization =
            new System.Net.Http.Headers.AuthenticationHeaderValue("Test");

        var response = await client.GetAsync("/api/data");

        Assert.Equal(System.Net.HttpStatusCode.OK, response.StatusCode);
    }
}

// Test authentication handler
public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(
        IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger,
        UrlEncoder encoder)
        : base(options, logger, encoder)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[]
        {
            new Claim(ClaimTypes.NameIdentifier, "test-user-id"),
            new Claim(ClaimTypes.Name, "Test User"),
            new Claim("scope", "read write")
        };

        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "Test");

        return Task.FromResult(AuthenticateResult.Success(ticket));
    }
}</code></pre>
                </div>

                <div class="docs-callout docs-callout-success">
                    <div class="docs-callout-title">Next Steps</div>
                    <ul>
                        <li>Explore <a href="../mcp/overview.html">MCP Integration</a> for AI assistant authentication</li>
                        <li>Review <a href="../api/endpoints.html">API Reference</a> for all available endpoints</li>
                        <li>Check <a href="../security/best-practices.html">Security Best Practices</a></li>
                    </ul>
                </div>
            </article>

            <aside class="docs-toc">
                <div class="docs-toc-title">On this page</div>
                <ul class="docs-toc-list">
                    <!-- Populated by JavaScript -->
                </ul>
            </aside>
        </main>

    <!-- Search Modal -->
    <div class="docs-search-modal" id="search-modal">
        <div class="docs-search-modal-content">
            <input type="text" id="search-modal-input" placeholder="Search documentation..." class="docs-search-modal-input">
            <div id="search-results" class="docs-search-results"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-docker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-http.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="/docs/js/docs.js"></script>
</body>
</html>
