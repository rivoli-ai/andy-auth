<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authorization Code Flow - Andy Auth Documentation</title>
    <meta name="description" content="Complete guide to implementing the OAuth 2.0 Authorization Code flow with Andy Auth">
    <link rel="stylesheet" href="/docs/css/docs.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <header class="docs-header">
        <div class="docs-header-inner">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="docs-mobile-toggle" id="sidebar-toggle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <a href="/docs/" class="docs-logo">
                    <svg viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="8" fill="currentColor"/><path d="M8 24V8h6l4 8 4-8h6v16h-5V14l-3.5 7h-3L13 14v10H8z" fill="white"/></svg>
                    <span class="docs-logo-text">
                        <span class="docs-logo-title">Andy Auth</span>
                        <span class="docs-logo-subtitle">Documentation</span>
                    </span>
                    <span class="docs-version">v1.0</span>
                </a>
            </div>
            <div class="docs-search">
                <div class="docs-search-wrapper">
                    <svg class="docs-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="docs-search-input" placeholder="Search documentation..." data-search-trigger readonly>
                    <span class="docs-search-shortcut">Ctrl K</span>
                </div>
            </div>
            <div class="docs-header-actions">
                <button class="docs-header-btn" id="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                </button>
                <a href="/" class="docs-header-link"><span>Back to App</span></a>
            </div>
        </div>
    </header>

    <aside class="docs-sidebar">
        <nav>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">Getting Started</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/" class="docs-sidebar-link">Overview</a></li>
                    <li><a href="/docs/installation.html" class="docs-sidebar-link">Installation</a></li>
                    <li><a href="/docs/configuration.html" class="docs-sidebar-link">Configuration</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">OAuth & OpenID Connect</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/oauth/concepts.html" class="docs-sidebar-link">Core Concepts</a></li>
                    <li><a href="/docs/oauth/authorization-code.html" class="docs-sidebar-link active">Authorization Code Flow</a></li>
                    <li><a href="/docs/oauth/pkce.html" class="docs-sidebar-link">PKCE</a></li>
                    <li><a href="/docs/oauth/client-credentials.html" class="docs-sidebar-link">Client Credentials</a></li>
                    <li><a href="/docs/oauth/access-tokens.html" class="docs-sidebar-link">Access Tokens</a></li>
                    <li><a href="/docs/oauth/refresh-tokens.html" class="docs-sidebar-link">Refresh Tokens</a></li>
                    <li><a href="/docs/oauth/scopes.html" class="docs-sidebar-link">Scopes</a></li>
                    <li><a href="/docs/oauth/claims.html" class="docs-sidebar-link">Claims</a></li>
                </ul>
            </div>
            <div class="docs-sidebar-section">
                <div class="docs-sidebar-title">API Reference</div>
                <ul class="docs-sidebar-nav">
                    <li><a href="/docs/api/endpoints.html" class="docs-sidebar-link">Endpoints Overview</a></li>
                    <li><a href="/docs/api/authorize.html" class="docs-sidebar-link">Authorization</a></li>
                    <li><a href="/docs/api/token.html" class="docs-sidebar-link">Token</a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <main class="docs-main">
        <article class="docs-content">
            <nav class="docs-breadcrumb">
                <a href="/docs/">Docs</a>
                <span class="docs-breadcrumb-sep">/</span>
                <a href="/docs/oauth/concepts.html">OAuth</a>
                <span class="docs-breadcrumb-sep">/</span>
                <span class="docs-breadcrumb-current">Authorization Code Flow</span>
            </nav>

            <h1>Authorization Code Flow</h1>
            <p class="lead">
                The Authorization Code flow is the most secure OAuth 2.0 flow for applications where
                the source code is not publicly exposed. It's the recommended flow for web applications,
                mobile apps, and AI clients like Claude Desktop.
            </p>

            <div class="callout callout-info">
                <div class="callout-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    PKCE Required
                </div>
                <p>
                    Andy Auth requires <a href="/docs/oauth/pkce.html">PKCE</a> for all public clients
                    (mobile apps, SPAs, desktop apps). This prevents authorization code interception attacks.
                </p>
            </div>

            <h2 id="flow-overview">Flow Overview</h2>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">text</span>
                </div>
                <pre><code>┌──────────────┐                              ┌──────────────┐
│              │                              │              │
│    Client    │                              │  Andy Auth   │
│              │                              │              │
└──────┬───────┘                              └──────┬───────┘
       │                                             │
       │  1. Authorization Request                   │
       │  (client_id, redirect_uri, scope,           │
       │   code_challenge, state)                    │
       │────────────────────────────────────────────>│
       │                                             │
       │  2. User authenticates & consents           │
       │                                             │
       │  3. Authorization Code                      │
       │<────────────────────────────────────────────│
       │                                             │
       │  4. Token Request                           │
       │  (code, redirect_uri, code_verifier)        │
       │────────────────────────────────────────────>│
       │                                             │
       │  5. Access Token + Refresh Token            │
       │<────────────────────────────────────────────│
       │                                             │</code></pre>
            </div>

            <h2 id="step-1">Step 1: Authorization Request</h2>
            <p>
                Direct the user's browser to Andy Auth's authorization endpoint with the required parameters.
            </p>

            <div class="endpoint">
                <span class="endpoint-method get">GET</span>
                <span class="endpoint-path">/connect/authorize</span>
            </div>

            <h3>Required Parameters</h3>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                        <th>Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>client_id</code></td>
                        <td>Your application's client ID</td>
                        <td><code>my-web-app</code></td>
                    </tr>
                    <tr>
                        <td><code>response_type</code></td>
                        <td>Must be <code>code</code></td>
                        <td><code>code</code></td>
                    </tr>
                    <tr>
                        <td><code>redirect_uri</code></td>
                        <td>Where to send the user after authorization</td>
                        <td><code>https://app.example.com/callback</code></td>
                    </tr>
                    <tr>
                        <td><code>scope</code></td>
                        <td>Space-separated list of requested scopes</td>
                        <td><code>openid profile email</code></td>
                    </tr>
                    <tr>
                        <td><code>state</code></td>
                        <td>Random string for CSRF protection</td>
                        <td><code>xyzABC123</code></td>
                    </tr>
                    <tr>
                        <td><code>code_challenge</code></td>
                        <td>PKCE code challenge (required for public clients)</td>
                        <td>Base64URL-encoded SHA256 hash</td>
                    </tr>
                    <tr>
                        <td><code>code_challenge_method</code></td>
                        <td>Must be <code>S256</code></td>
                        <td><code>S256</code></td>
                    </tr>
                </tbody>
            </table>

            <h3>Example Request</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">http</span>
                    <button class="code-block-copy">Copy</button>
                </div>
                <pre><code>GET /connect/authorize?
  client_id=my-web-app&
  response_type=code&
  redirect_uri=https://app.example.com/callback&
  scope=openid%20profile%20email%20offline_access&
  state=af0ifjsldkj&
  code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM&
  code_challenge_method=S256
HTTP/1.1
Host: auth.example.com</code></pre>
            </div>

            <h2 id="step-2">Step 2: User Authentication</h2>
            <p>
                Andy Auth displays the login page where the user enters their credentials. If the user
                is already logged in, they may be shown a consent screen to approve the requested scopes.
            </p>

            <div class="callout callout-success">
                <div class="callout-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    Two-Factor Authentication
                </div>
                <p>
                    If the user has 2FA enabled, they'll be prompted for their TOTP code after
                    entering their password. Andy Auth supports authenticator apps like Google
                    Authenticator, Authy, and 1Password.
                </p>
            </div>

            <h2 id="step-3">Step 3: Authorization Response</h2>
            <p>
                After successful authentication and consent, Andy Auth redirects the user back to
                your <code>redirect_uri</code> with an authorization code.
            </p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">http</span>
                </div>
                <pre><code>HTTP/1.1 302 Found
Location: https://app.example.com/callback?
  code=SplxlOBeZQQYbYS6WxSbIA&
  state=af0ifjsldkj</code></pre>
            </div>

            <div class="callout callout-warning">
                <div class="callout-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Always Validate State
                </div>
                <p>
                    Compare the returned <code>state</code> with the one you sent in Step 1.
                    If they don't match, the response may be from a CSRF attack - reject it.
                </p>
            </div>

            <h2 id="step-4">Step 4: Token Exchange</h2>
            <p>
                Exchange the authorization code for tokens by making a POST request to the token endpoint.
            </p>

            <div class="endpoint">
                <span class="endpoint-method post">POST</span>
                <span class="endpoint-path">/connect/token</span>
            </div>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">http</span>
                    <button class="code-block-copy">Copy</button>
                </div>
                <pre><code>POST /connect/token HTTP/1.1
Host: auth.example.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=SplxlOBeZQQYbYS6WxSbIA&
redirect_uri=https://app.example.com/callback&
client_id=my-web-app&
code_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk</code></pre>
            </div>

            <h3>Parameters</h3>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>grant_type</code></td>
                        <td>Must be <code>authorization_code</code></td>
                    </tr>
                    <tr>
                        <td><code>code</code></td>
                        <td>The authorization code from Step 3</td>
                    </tr>
                    <tr>
                        <td><code>redirect_uri</code></td>
                        <td>Same redirect URI used in Step 1</td>
                    </tr>
                    <tr>
                        <td><code>client_id</code></td>
                        <td>Your application's client ID</td>
                    </tr>
                    <tr>
                        <td><code>code_verifier</code></td>
                        <td>The PKCE code verifier (original random string)</td>
                    </tr>
                    <tr>
                        <td><code>client_secret</code></td>
                        <td>Required for confidential clients only</td>
                    </tr>
                </tbody>
            </table>

            <h2 id="step-5">Step 5: Token Response</h2>
            <p>Andy Auth returns the tokens in a JSON response:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">json</span>
                    <button class="code-block-copy">Copy</button>
                </div>
                <pre><code>{
  "access_token": "kYjE7d5GS2mLZ8wQP3F1nXrT9vHcA0bU",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "tGzv3JOkF0XG5Qx2TlKWIA",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "scope": "openid profile email offline_access"
}</code></pre>
            </div>

            <h3>Response Fields</h3>
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>access_token</code></td>
                        <td>Use this to access protected APIs</td>
                    </tr>
                    <tr>
                        <td><code>token_type</code></td>
                        <td>Always <code>Bearer</code></td>
                    </tr>
                    <tr>
                        <td><code>expires_in</code></td>
                        <td>Token lifetime in seconds (default: 3600)</td>
                    </tr>
                    <tr>
                        <td><code>refresh_token</code></td>
                        <td>Use to get new access tokens (if <code>offline_access</code> requested)</td>
                    </tr>
                    <tr>
                        <td><code>id_token</code></td>
                        <td>JWT with user identity (if <code>openid</code> scope requested)</td>
                    </tr>
                    <tr>
                        <td><code>scope</code></td>
                        <td>Scopes granted (may differ from requested)</td>
                    </tr>
                </tbody>
            </table>

            <h2 id="complete-example">Complete Example</h2>
            <p>Here's a complete JavaScript example implementing the Authorization Code flow with PKCE:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">javascript</span>
                    <button class="code-block-copy">Copy</button>
                </div>
                <pre><code>// Configuration
const config = {
  authServer: 'https://auth.example.com',
  clientId: 'my-web-app',
  redirectUri: 'https://app.example.com/callback',
  scope: 'openid profile email offline_access'
};

// Generate PKCE values
async function generatePKCE() {
  const verifier = crypto.randomUUID() + crypto.randomUUID();
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const challenge = btoa(String.fromCharCode(...new Uint8Array(hash)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
  return { verifier, challenge };
}

// Step 1: Start authorization
async function startAuth() {
  const { verifier, challenge } = await generatePKCE();
  const state = crypto.randomUUID();

  // Store for later verification
  sessionStorage.setItem('pkce_verifier', verifier);
  sessionStorage.setItem('oauth_state', state);

  const params = new URLSearchParams({
    client_id: config.clientId,
    response_type: 'code',
    redirect_uri: config.redirectUri,
    scope: config.scope,
    state: state,
    code_challenge: challenge,
    code_challenge_method: 'S256'
  });

  window.location.href = `${config.authServer}/connect/authorize?${params}`;
}

// Step 4: Handle callback and exchange code
async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const state = params.get('state');

  // Verify state
  if (state !== sessionStorage.getItem('oauth_state')) {
    throw new Error('State mismatch - possible CSRF attack');
  }

  // Exchange code for tokens
  const response = await fetch(`${config.authServer}/connect/token`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: config.redirectUri,
      client_id: config.clientId,
      code_verifier: sessionStorage.getItem('pkce_verifier')
    })
  });

  const tokens = await response.json();

  // Clean up
  sessionStorage.removeItem('pkce_verifier');
  sessionStorage.removeItem('oauth_state');

  return tokens;
}</code></pre>
            </div>

            <h2 id="error-handling">Error Handling</h2>
            <p>
                If something goes wrong, Andy Auth returns an error in the redirect or token response:
            </p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-lang">http</span>
                </div>
                <pre><code>// Authorization error (redirect)
https://app.example.com/callback?
  error=access_denied&
  error_description=The+user+denied+the+authorization+request&
  state=af0ifjsldkj

// Token error (JSON response)
{
  "error": "invalid_grant",
  "error_description": "The authorization code has expired."
}</code></pre>
            </div>

            <h3>Common Errors</h3>
            <table>
                <thead>
                    <tr>
                        <th>Error</th>
                        <th>Description</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>invalid_client</code></td>
                        <td>Client ID not found or disabled</td>
                        <td>Verify your client_id is correct</td>
                    </tr>
                    <tr>
                        <td><code>invalid_grant</code></td>
                        <td>Code expired or already used</td>
                        <td>Start a new authorization flow</td>
                    </tr>
                    <tr>
                        <td><code>invalid_request</code></td>
                        <td>Missing or invalid parameters</td>
                        <td>Check all required parameters</td>
                    </tr>
                    <tr>
                        <td><code>access_denied</code></td>
                        <td>User denied consent</td>
                        <td>Handle gracefully in your app</td>
                    </tr>
                    <tr>
                        <td><code>invalid_scope</code></td>
                        <td>Requested scope not allowed</td>
                        <td>Request only permitted scopes</td>
                    </tr>
                </tbody>
            </table>

            <nav class="docs-page-nav">
                <a href="/docs/oauth/concepts.html" class="docs-page-nav-link prev">
                    <span class="docs-page-nav-label">Previous</span>
                    <span class="docs-page-nav-title">Core Concepts</span>
                </a>
                <a href="/docs/oauth/pkce.html" class="docs-page-nav-link next">
                    <span class="docs-page-nav-label">Next</span>
                    <span class="docs-page-nav-title">PKCE</span>
                </a>
            </nav>
        </article>

        <aside class="docs-toc">
            <div class="docs-toc-title">On this page</div>
            <ul class="docs-toc-list"></ul>
        </aside>
    </main>

    <div class="docs-search-modal" id="search-modal">
        <div class="docs-search-modal-content">
            <input type="text" class="docs-search-modal-input" id="search-modal-input" placeholder="Search documentation...">
            <div class="docs-search-results" id="search-results"></div>
        </div>
    </div>

    <script src="/docs/js/docs.js"></script>
</body>
</html>
